# ============================================================
# NIMONSPEDIA - NGINX REVERSE PROXY CONFIGURATION
# ============================================================
# 
# ROUTING LOGIC:
# 1. PHP Backend (Milestone 1): All existing pages - login, register, home, 
#    buyer, seller, product, store, cart, checkout, balance, orders
# 2. React SPA (Milestone 2): New features only - /auctions, /auction/*, /chat, /admin
# 3. Node.js API: REST API at /api/node/* and WebSocket at /socket.io
# 4. Static files: PHP public assets at /public/*, React assets
#
# ============================================================

upstream php_backend {
    server php:80;
}

upstream node_backend {
    server node:3000;
}

server {
    listen 80;
    server_name localhost;
    
    # Increase buffer size for WebSocket
    proxy_buffer_size 128k;
    proxy_buffers 4 256k;
    proxy_busy_buffers_size 256k;

    # ============================================================
    # SECTION 1: NODE.JS API & WEBSOCKET (Highest Priority)
    # ============================================================
    
    # Node.js REST API
    location /api/node/ {
        proxy_pass http://node_backend;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header Cookie $http_cookie;
        proxy_read_timeout 60s;
        proxy_connect_timeout 60s;
    }

    # WebSocket for Socket.io
    location /socket.io/ {
        proxy_pass http://node_backend/socket.io/;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_redirect off;
        
        # WebSocket specific settings
        proxy_buffering off;
        proxy_cache off;
        proxy_connect_timeout 60s;
        proxy_send_timeout 60s;
        proxy_read_timeout 60s;
    }

    # ============================================================
    # SECTION 2: REACT SPA ROUTES (Milestone 2 New Features Only)
    # ============================================================
    # These routes serve React SPA for new Milestone 2 features
    
    # Auction list and detail pages (React)
    location /auctions {
        alias /usr/share/nginx/html;
        try_files $uri $uri/ /index.html;
    }
    
    location ~ ^/auction/[0-9]+$ {
        root /usr/share/nginx/html;
        try_files $uri /index.html;
    }

    # Chat page (React)
    location /chat {
        alias /usr/share/nginx/html;
        try_files $uri $uri/ /index.html;
    }

    # Admin pages (React)
    location /admin {
        alias /usr/share/nginx/html;
        try_files $uri $uri/ /index.html;
    }

    # React static assets (JS, CSS, images from Vite build)
    location /assets/ {
        alias /usr/share/nginx/html/assets/;
        expires 1y;
        add_header Cache-Control "public, immutable";
    }

    # ============================================================
    # SECTION 3: PHP BACKEND ROUTES (Milestone 1 Features)
    # ============================================================
    # All existing PHP pages and functionality
    
    # Homepage - PHP serves the main landing page
    location = / {
        proxy_pass http://php_backend/;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header Cookie $http_cookie;
        proxy_cookie_path / /;
    }

    # Auth routes (login, register, logout, profile)
    location /auth {
        proxy_pass http://php_backend;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header Cookie $http_cookie;
        proxy_cookie_path / /;
    }

    location /login {
        proxy_pass http://php_backend;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header Cookie $http_cookie;
        proxy_cookie_path / /;
    }

    location /logout {
        proxy_pass http://php_backend;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header Cookie $http_cookie;
        proxy_cookie_path / /;
    }

    location /register {
        proxy_pass http://php_backend;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header Cookie $http_cookie;
        proxy_cookie_path / /;
    }

    # Main app pages
    location /home {
        proxy_pass http://php_backend;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header Cookie $http_cookie;
        proxy_cookie_path / /;
    }

    location /buyer {
        proxy_pass http://php_backend;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header Cookie $http_cookie;
        proxy_cookie_path / /;
    }

    location /seller {
        proxy_pass http://php_backend;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header Cookie $http_cookie;
        proxy_cookie_path / /;
    }

    location /product {
        proxy_pass http://php_backend;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header Cookie $http_cookie;
        proxy_cookie_path / /;
    }

    location /store {
        proxy_pass http://php_backend;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header Cookie $http_cookie;
        proxy_cookie_path / /;
    }

    location /cart {
        proxy_pass http://php_backend;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header Cookie $http_cookie;
        proxy_cookie_path / /;
    }

    location /checkout {
        proxy_pass http://php_backend;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header Cookie $http_cookie;
        proxy_cookie_path / /;
    }

    location /balance {
        proxy_pass http://php_backend;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header Cookie $http_cookie;
        proxy_cookie_path / /;
    }

    location /order {
        proxy_pass http://php_backend;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header Cookie $http_cookie;
        proxy_cookie_path / /;
    }

    location /orders {
        proxy_pass http://php_backend;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header Cookie $http_cookie;
        proxy_cookie_path / /;
    }

    location /search {
        proxy_pass http://php_backend;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header Cookie $http_cookie;
        proxy_cookie_path / /;
    }

    location /profile {
        proxy_pass http://php_backend;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header Cookie $http_cookie;
        proxy_cookie_path / /;
    }

    # PHP REST API (for internal use)
    location /api/php/ {
        rewrite ^/api/php/(.*)$ /$1 break;
        proxy_pass http://php_backend;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header Cookie $http_cookie;
        proxy_cookie_path / /;
    }

    # ============================================================
    # SECTION 4: STATIC FILES
    # ============================================================
    
    # PHP public static files (CSS, JS, images, uploads)
    location /public/ {
        proxy_pass http://php_backend/public/;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        
        # Cache static assets
        expires 1y;
        add_header Cache-Control "public, immutable";
    }

    # Uploaded files (product images, store logos, etc.)
    location /uploads/ {
        proxy_pass http://php_backend/uploads/;
        proxy_set_header Host $host;
        expires 1y;
        add_header Cache-Control "public, immutable";
    }

    # ============================================================
    # SECTION 5: ERROR HANDLING
    # ============================================================
    
    error_page 404 /404.html;
    error_page 500 502 503 504 /50x.html;

    location = /50x.html {
        root /usr/share/nginx/html;
    }

    # Deny access to dot files
    location ~ /\. {
        deny all;
    }
}

# ============================================================
# ROUTE MAP DOCUMENTATION
# ============================================================
#
# PHP Backend (http://php:80) - Milestone 1 Features:
# ┌─────────────────────────────────────────────────────────┐
# │ /              → Homepage (main landing page)           │
# │ /login         → Login page                             │
# │ /logout        → Logout action                          │
# │ /register      → Registration selection                 │
# │ /auth/*        → Authentication endpoints               │
# │ /home          → User dashboard after login             │
# │ /buyer/*       → Buyer-specific pages                   │
# │ /seller/*      → Seller-specific pages                  │
# │ /product/*     → Product pages                          │
# │ /store/*       → Store pages                            │
# │ /cart          → Shopping cart                          │
# │ /checkout      → Checkout process                       │
# │ /balance       → Balance/wallet management              │
# │ /order/*       → Order management                       │
# │ /orders        → Order history                          │
# │ /search        → Product search                         │
# │ /profile       → User profile                           │
# │ /public/*      → Static assets (CSS, JS, images)        │
# │ /uploads/*     → User uploaded files                    │
# └─────────────────────────────────────────────────────────┘
#
# React SPA (Nginx static) - Milestone 2 Features:
# ┌─────────────────────────────────────────────────────────┐
# │ /auctions      → Auction list page                      │
# │ /auction/:id   → Auction detail page                    │
# │ /chat          → Chat page                              │
# │ /admin         → Admin dashboard                        │
# │ /assets/*      → React build assets                     │
# └─────────────────────────────────────────────────────────┘
#
# Node.js Backend (http://node:3000) - API & WebSocket:
# ┌─────────────────────────────────────────────────────────┐
# │ /api/node/*    → REST API endpoints                     │
# │ /socket.io/*   → WebSocket connections                  │
# └─────────────────────────────────────────────────────────┘
#
# USER FLOW:
# 1. User visits localhost/ → PHP homepage
# 2. User clicks Login → /login (PHP)
# 3. After login → /home (PHP dashboard)
# 4. User clicks "Auctions" → /auctions (React SPA)
# 5. User clicks an auction → /auction/123 (React SPA)
# 6. React uses /api/node/* for data, /socket.io for real-time
# 7. User returns to store → /home (PHP)
#
